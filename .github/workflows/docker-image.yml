name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    runs-on: ubuntu-18.04
    #env:
    #  AWS_ACCESS_KEY_ID: ASIA3H4P5VZX7UR645E4
    #  AWS_SECRET_ACCESS_KEY: OQlrX4WcQyjBdwird4Kzz7JUQZoigLyDHhYAyv8b
    #  AWS_DEFAULT_REGION: us-east-1

    steps:
    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag app
    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file Dockerfile_mysql --tag mysql
    #- uses: actions/checkout@v3
    #- name: AWS credentials
    #  run: mkdir ~/.aws && touch ~/.aws/credentials && echo "[default]" >> ~/.aws/credentials && echo "aws_access_key_id=ASIA3H4P5VZX7UR645E4" >> ~/.aws/credentials && echo "aws_secret_access_key=OQlrX4WcQyjBdwird4Kzz7JUQZoigLyDHhYAyv8b" >> ~/.aws/credentials && echo "aws_session_token=FwoGZXIvYXdzEKv//////////wEaDNb2rUjGuc2wBVPseSLAATzBX2kfrTtaGyBIO1Up53sGuB40Syju8hq443jnl/rskRM2vOpONiDSZS4rYAm5Qgi1HMrIYbbR3zkYxq8ANhv01Fa4tPAEsP0RJCDKAKnM3W1e5FjApXKNKG82Xi51G5HbhgbP1VzIg9EsYsWiuBbAO5QxQuyLqcPUlBLcPewuiYrA7kxIxgCvggEC4MGxVJMS75rFPsS71IWt+kej6RdjJpG9lCX5XymCsSoRAMny7bvTAoM81gYLb68yJOw20yjwi9mZBjItMNA7Ry6pLzHVoTejhp6JsMNS7YPfKpfCKyeRk9Nfob5Xa81ctJkEymkUwXuH" >> ~/.aws/credentials && cat ~/.aws/credentials
    - uses: actions/checkout@v3
    - name: AWS configure
      run: aws configure set aws_access_key_id ASIA3H4P5VZX7UR645E4 && aws configure set aws_secret_access_key OQlrX4WcQyjBdwird4Kzz7JUQZoigLyDHhYAyv8b && export AWS_DEFAULT_REGION=us-east-1
    - uses: actions/checkout@v3
    - name: Login to AWS
      #run: aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 772859080303.dkr.ecr.us-east-1.amazonaws.com/clo835assignment1
      run: docker login -u AWS -p $(aws ecr get-login-password --region us-east-1) 772859080303.dkr.ecr.us-east-1.amazonaws.com
    - uses: actions/checkout@v3
    - name: Pushing a docker image
      run: docker push 772859080303.dkr.ecr.us-east-1.amazonaws.com/clo835assignment1
